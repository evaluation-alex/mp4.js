/* mp4.js - Licensed under Apache License 2 https://github.com/ukyo/mp4.js/blob/master/LICENSE */var mp4;(function(t){var e=Object.prototype.toString,r=new Uint8Array(32768),i=new Uint16Array(r.buffer),n=new Uint32Array(r.buffer),s=function(t){for(var e=r.byteLength+t,s=r.byteLength;e>s;)s*=2;var a=new Uint8Array(s);a.set(r),r=a,i=new Uint16Array(a.buffer),n=new Uint32Array(a.buffer)},a=function(){function t(t,r,i){if("number"==typeof t)this.view=new DataView(new ArrayBuffer(t));else switch(e.call(t)){case"[object ArrayBuffer]":r=r||0,i=i||t.byteLength,this.view=new DataView(t,r,i);break;case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object CanvasPixelArray]":case"[object Int8Array]":case"[object Uint16Array]":case"[object Int16Array]":case"[object Uint32Array]":case"[object Int32Array]":case"[object Float32Array]":case"[object Float64Array]":case"[object DataView]":this.view=void 0===r&&void 0===i?new DataView(t.buffer,t.byteOffset,t.byteLength):void 0!==r&&void 0===i?new DataView(t.buffer,t.byteOffset+r):void 0===r&&void 0!==i?new DataView(t.buffer,t.byteOffset,i):new DataView(t.buffer,r,i);break;default:throw new TypeError}this.buffer=this.view.buffer,this.byteOffset=this.view.byteOffset,this.byteLength=this.view.byteLength}return t.prototype.getUint8=function(t){return this.view.getUint8(t)},t.prototype.setUint8=function(t,e){this.view.setUint8(t,e)},t.prototype.getInt8=function(t){return this.view.getInt8(t)},t.prototype.setInt8=function(t,e){this.view.setInt8(t,e)},t.prototype.getUint16=function(t,e){return e===void 0&&(e=!1),this.view.getUint16(t,e)},t.prototype.setUint16=function(t,e,r){r===void 0&&(r=!1),this.view.setUint16(t,e,r)},t.prototype.getInt16=function(t,e){return e===void 0&&(e=!1),this.view.getInt16(t,e)},t.prototype.setInt16=function(t,e,r){r===void 0&&(r=!1),this.view.setInt16(t,e,r)},t.prototype.getUint32=function(t,e){return e===void 0&&(e=!1),this.view.getUint32(t,e)},t.prototype.setUint32=function(t,e,r){r===void 0&&(r=!1),this.view.setUint32(t,e,r)},t.prototype.getInt32=function(t,e){return e===void 0&&(e=!1),this.view.getInt32(t,e)},t.prototype.setInt32=function(t,e,r){r===void 0&&(r=!1),this.view.setInt32(t,e,r)},t.prototype.getFloat32=function(t,e){return e===void 0&&(e=!1),this.view.getFloat32(t,e)},t.prototype.setFloat32=function(t,e,r){r===void 0&&(r=!1),this.view.setFloat32(t,e,r)},t.prototype.getFloat64=function(t,e){return e===void 0&&(e=!1),this.view.getFloat64(t,e)},t.prototype.setFloat64=function(t,e,r){r===void 0&&(r=!1),this.view.setFloat64(t,e,r)},t.prototype.getString=function(t,e){var r=new Uint8Array(this.buffer,this.byteOffset+t,e);return String.fromCharCode.apply(null,r)},t.prototype.setString=function(t,e){for(var r=new Uint8Array(this.buffer,this.byteOffset+t),i=e.length;i;)r[--i]=e.charCodeAt(i)},t.prototype.getUTF8String=function(e){var r=new Uint8Array(this.buffer,this.byteOffset+e,this.byteLength);return t.UTF8BytesToString(r)},t.stringToUTF8Bytes=function(t){var e,i,n=t.length,a=-1,o=r,p=o.byteLength;for(e=0;n>e;++e)i=t.charCodeAt(e),127>=i?o[++a]=i:2047>=i?(o[++a]=192|i>>>6,o[++a]=128|63&i):65535>=i?(o[++a]=224|i>>>12,o[++a]=128|63&i>>>6,o[++a]=128|63&i):(o[++a]=240|i>>>18,o[++a]=128|63&i>>>12,o[++a]=128|63&i>>>6,o[++a]=128|63&i),4>=p-a&&(s(4),o=r);var u=new Uint8Array(++a);return u.set(o.subarray(0,a)),u},t.UTF8BytesToString=function(t){for(var e,r=t.byteLength,i=n,s=0,a=0,o="";r>a;){for(s=0;4096>s&&r>a;++a,++s)e=t[a],128>e?i[s]=e:6===e>>>5?(i[s]=(31&e)<<6,i[s]|=63&t[++a]):14===e>>>4?(i[s]=(15&e)<<12,i[s]|=(63&t[++a])<<6,i[s]|=63&t[++a]):(i[s]=(7&e)<<18,i[s]|=(63&t[++a])<<12,i[s]|=(63&t[++a])<<6,i[s]|=63&t[++a]);o+=String.fromCharCode.apply(i.subarray(0,s))}return o},t.prototype.setUTF8String=function(e,r){var i=t.stringToUTF8Bytes(r),n=new Uint8Array(this.buffer,this.byteOffset,this.byteLength);return n.set(i,e),i.length},t.prototype.getUint24=function(t,e){e===void 0&&(e=!1);var r=new Uint8Array(this.buffer,this.byteOffset+t);return e?r[0]|r[1]<<8|r[2]<<16:r[2]|r[1]<<8|r[0]<<16},t.prototype.setUint24=function(t,e,r){r===void 0&&(r=!1);var i=new Uint8Array(this.buffer,this.byteOffset+t);r?(i[0]=255&e,i[1]=(65280&e)>>8,i[2]=(16711680&e)>>16):(i[2]=255&e,i[1]=(65280&e)>>8,i[0]=(16711680&e)>>16)},t.prototype.getInt24=function(t,e){e===void 0&&(e=!1);var r=this.getUint24(t,e);return 8388608&r?r-16777216:r},t.prototype.setInt24=function(t,e,r){r===void 0&&(r=!1),this.setUint24(t,e,r)},t}();t.DataView2=a})(mp4||(mp4={}));var mp4;(function(t){(function(e){var r=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431],i=Math.pow(2,25),n=function(){function e(e){this.bytes=e,this.bitOffset=0,this.view=new t.DataView2(e)}return e.prototype.parse=function(){throw Error("not implemented error.")},e.prototype.readBits=function(t){if(0>=t)throw Error();for(var e,n,s,a=25,o=0;t>0;){switch(s=t>a?a:t,o*=i,n=Math.ceil((this.bitOffset%8+s)/8)){case 1:e=this.view.getUint8(this.byteOffset);break;case 2:e=this.view.getUint16(this.byteOffset);break;case 3:e=this.view.getUint24(this.byteOffset);break;case 4:e=this.view.getUint32(this.byteOffset)}o+=e>>>8*n-(this.bitOffset%8+s)&r[s],this.skipBits(s),t-=s}return o},e.prototype.readUint8=function(){var t=this.view.getUint8(this.byteOffset);return this.skipBytes(1),t},e.prototype.readInt8=function(){var t=this.view.getInt8(this.byteOffset);return this.skipBytes(1),t},e.prototype.readUint16=function(){var t=this.view.getUint16(this.byteOffset);return this.skipBytes(2),t},e.prototype.readInt16=function(){var t=this.view.getInt16(this.byteOffset);return this.skipBytes(2),t},e.prototype.readUint24=function(){var t=this.view.getUint24(this.byteOffset);return this.skipBytes(3),t},e.prototype.readInt24=function(){var t=this.view.getInt24(this.byteOffset);return this.skipBytes(3),t},e.prototype.readUint32=function(){var t=this.view.getUint32(this.byteOffset);return this.skipBytes(4),t},e.prototype.readInt32=function(){var t=this.view.getInt32(this.byteOffset);return this.skipBytes(4),t},e.prototype.readFloat32=function(){var t=this.view.getFloat32(this.byteOffset);return this.skipBytes(4),t},e.prototype.readFloat64=function(){var t=this.view.getFloat64(this.byteOffset);return this.skipBytes(8),t},e.prototype.readBytes=function(t){var e=this.byteOffset,r=this.bytes.subarray(e,e+t);return this.skipBytes(t),r},e.prototype.readString=function(t){t===void 0&&(t=0);var e;if(0===t){var r=this.bytes.subarray(this.byteOffset);e=String.fromCharCode.apply(null,r),t=r.length}else e=this.view.getString(this.byteOffset,t);return this.skipBytes(t),e},e.prototype.readStringNullTerminated=function(){for(var t=this.bytes.subarray(this.byteOffset),e=0;0===t[e++];);return this.skipBytes(e),String.fromCharCode.apply(null,t.subarray(0,e-1))},e.prototype.readUTF8StringNullTerminated=function(){for(var e=this.bytes.subarray(this.byteOffset),r=0;0===e[r++];);return this.skipBytes(r),new t.DataView2(e).getUTF8String(0,r-1)},e.prototype.skipBits=function(t){this.bitOffset+=t},e.prototype.skipBytes=function(t){this.bitOffset+=8*t},Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this.bitOffset>>>3},enumerable:!0,configurable:!0}),e.prototype.isEnd=function(){return this.bitOffset/8>=this.bytes.length},e}();e.BaseParser=n})(t.parser||(t.parser={})),t.parser})(mp4||(mp4={}));var __extends=this.__extends||function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r},mp4;(function(t){(function(e){e.getDescrInfo=function(t,e){e===void 0&&(e=0);for(var r=t[e++],i=t[e++],n=127&i,s=2;128&i;)s++,i=t[e++],n<<=7,n|=127&i;return{tag:r,byteLength:s+n,bodyLength:n}};var r=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.parse=function(){var t=e.getDescrInfo(this.bytes);return this.skipBytes(this.getBodyOffset()),{byteLength:this.bytes.byteLength,bodyLength:t.bodyLength,tag:this.bytes[0],bytes:this.bytes}},r.prototype.getBodyOffset=function(){for(var t=1;128&this.bytes[t++];);return t},r}(e.BaseParser);e.DescriptorParser=r;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.tag=5,e}(r);e.DecoderSpecificInfoParser=i;var n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.tag=20,e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.profileLevelIndicationIndex=this.readUint8(),e},e}(r);e.ProfileLevelINdicationIndexDescriptor=n;var s=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.tag=4,r.prototype.parse=function(){var r=t.prototype.parse.call(this);r.objectTypeIndication=this.readUint8(),r.streamType=this.readBits(6),r.upStream=this.readBits(1),this.skipBits(1),r.bufferSizeDB=this.readUint24(),r.maxBitrate=this.readUint32(),r.avgBitrate=this.readUint32();var s,a,o;for(r.profileLevelIndicationIndexDescrs=[];!this.isEnd();)if(s=e.getDescrInfo(this.bytes.subarray(this.byteOffset)),a=e.createDescriptorParser(this.readBytes(s.byteLength),s.tag),o=a.parse(),a instanceof i)r.decSpecificInfo=o;else{if(!(a instanceof n))throw new TypeError;r.profileLevelIndicationIndexDescrs.push(o)}return r},r}(r);e.DecoderConfigDescriptorParser=s;var a=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.tag=6,e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.preDefined=this.readUint8(),0===e.preDefined&&(e.useAccessUnitStartFlag=this.readBits(1),e.useAccessUnitEndFlag=this.readBits(1),e.useRandomAccessPointFlag=this.readBits(1),e.hasRandomAccessUnitsOnlyFlag=this.readBits(1),e.usePaddingFlag=this.readBits(1),e.useTimeStampsFlag=this.readBits(1),e.useIdleFlag=this.readBits(1),e.durationFlag=this.readBits(1),e.timeStampResolution=this.readUint32(),e.ocrResolution=this.readUint32(),e.timeStampLength=this.readUint8(),e.ocrLength=this.readUint8(),e.auLength=this.readUint8(),e.instantBitrateLength=this.readUint8(),e.degradationPriorityLength=this.readBits(4),e.auSeqNumLength=this.readBits(5),e.packetSeqNumLength=this.readBits(5),this.skipBits(2)),e.durationFlag&&(e.timeScale=this.readUint32(),e.accessUnitDuration=this.readUint16(),e.compositionUnitDuration=this.readUint16()),0===e.useTimeStampsFlag&&(e.startDecodingTimeStamp=this.readBits(e.timeStampLength),e.startCompositionTimeStamp=this.readBits(e.timeStampLength)),e},e}(r);e.SLConfigDescriptorParser=a;var o=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.IPIDescriptorPointerParser=o;var p=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.IPIdentificationDataSetParser=p;var u=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.IPMPDescriptorPointerParser=u;var h=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.LanguageDescriptorParser=h;var f=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.QosDescriptorParser=f;var c=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);e.ExtensionDescriptorParser=c;var y=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.tag=3,r.prototype.parse=function(){var r,i,n,u=t.prototype.parse.call(this);for(u.esID=this.readUint16(),u.streamDependenceFlag=this.readBits(1),u.urlFlag=this.readBits(1),this.skipBits(1),u.streamPriority=this.readBits(5),u.streamDependenceFlag&&(u.dependsOnEsID=this.readUint16()),u.urlFlag&&(u.urlLength=this.readUint8(),u.urlString=this.readString(u.urlLength)),u.ipIDSs=[],u.ipmpDescrPtrs=[],u.langDescrs=[],u.extDescrs=[];!this.isEnd();)if(r=e.getDescrInfo(this.bytes.subarray(this.byteOffset)),i=e.createDescriptorParser(this.readBytes(r.byteLength),r.tag),n=i.parse(),i instanceof s)u.decConfigDescr=n;else if(i instanceof a)u.slConfigDescr=n;else if(i instanceof o)u.ipiPtr=n;else if(i instanceof p)u.ipIDSs.push(n);else if(i instanceof h)u.langDescrs.push(n);else if(i instanceof f)u.qosDescr=n;else{if(!(i instanceof c))throw new TypeError;u.extDescrs.push(n)}return u},r}(r);e.ESDescriptorParser=y,e.createDescriptorParser=function(){var e={};return Object.keys(t.parser).forEach(function(r){var i=t.parser[r];null!=i.tag&&(Array.isArray(i.tag)?i.tag.forEach(function(t){return e[t]=i}):e[i.tag]=i)}),function(t,i){return new(e[i]||r)(t)}}()})(t.parser||(t.parser={})),t.parser})(mp4||(mp4={}));var __extends=this.__extends||function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r},mp4;(function(t){(function(e){var r=function(e,r){r===void 0&&(r=0);var i=new t.DataView2(e,r);return{byteLength:i.getUint32(0),type:i.getString(4,4)}},i=function(t){function i(e){t.call(this,e)}return __extends(i,t),i.prototype.parse=function(){for(var t,i=[];!this.isEnd();)t=r(this.readBytes(8)),this.skipBytes(-8),i.push(e.createBoxParser(this.readBytes(t.byteLength),t.type).parse());return i},i}(e.BaseParser);e.RootParser=i;var n=function(t){function e(e){t.call(this,e),this.byteLength=this.bytes.length,this.skipBytes(4),this.type=this.readString(4)}return __extends(e,t),e.type="",e.prototype.parse=function(){return{byteLength:this.byteLength,type:this.type,bytes:this.bytes}},e}(e.BaseParser);e.BoxParser=n;var s=function(t){function e(e){t.call(this,e),this.version=this.readUint8(),this.flags=this.readUint24()}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.version=this.version,e.flags=this.flags,e},e}(n);e.FullBoxParser=s;var a=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="ftyp",e.prototype.parse=function(){var e=t.prototype.parse.call(this);for(e.majorBrand=this.readString(4),e.minorVersion=this.readUint32(),e.compatibleBrands=[];!this.isEnd();)e.compatibleBrands.push(this.readString(4));return e},e}(n);e.FileTypeBoxParser=a;var o=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.parse=function(){for(var i,n=t.prototype.parse.call(this),s=[];!this.isEnd();)i=r(this.readBytes(8)),this.skipBytes(-8),s.push(e.createBoxParser(this.readBytes(i.byteLength),i.type).parse());return n.boxes=s,n},i}(n);e.BoxListParser=o;var p=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="moov",e}(o);e.MovieBoxParser=p;var u=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mdat",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.data=this.bytes.subarray(8),e},e}(n);e.MediaDataBoxParser=u;var h=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mvhd",e.prototype.parse=function(){var e=t.prototype.parse.call(this);e.matrix=[],e.creationTime=this.readUint32(),e.modificationTime=this.readUint32(),e.timescale=this.readUint32(),e.duration=this.readUint32(),e.rate=this.readUint32(),e.volume=this.readUint16(),this.skipBytes(2),this.skipBytes(8);for(var r=0;9>r;++r)e.matrix.push(this.readInt32());return this.skipBytes(24),e.nextTrackID=this.readUint32(),e},e}(s);e.MovieHeaderBoxParser=h;var f=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="trak",e}(o);e.TrackBoxParser=f;var c=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="tkhd",e.prototype.parse=function(){var e=t.prototype.parse.call(this);e.matrix=[],e.creationTime=this.readUint32(),e.modificationTime=this.readUint32(),e.trackID=this.readUint32(),this.skipBytes(4),e.duration=this.readUint32(),this.skipBytes(8),e.layer=this.readInt16(),e.alternateGroup=this.readInt16(),e.volume=this.readInt16()/256,this.skipBytes(2);for(var r=0;9>r;++r)e.matrix.push(this.readInt32());return e.width=this.readUint32(),e.height=this.readUint32(),e},e}(s);e.TrackHeaderBoxParser=c;var y=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="tref",e}(o);e.TrackReferenceBox=y;var d=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);for(e.trackIDs=[];!this.isEnd();)e.trackIDs.push(this.readUint32());return e},e}(n);e.TrackReferenceTypeBox=d;var l=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="hint",e}(d);e.TrackReferenceTypeHintBox=l;var m=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="cdsc",e}(d);e.TrackReferenceTypeDiscribeBox=m;var v=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mdia",e}(o);e.MediaBoxParser=v;var g=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mdhd",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.creationTime=this.readUint32(),e.modificationTime=this.readUint32(),e.timescale=this.readUint32(),e.duration=this.readUint32(),this.skipBits(1),e.language=String.fromCharCode.apply(null,[this.readBits(5),this.readBits(5),this.readBits(5)].map(function(t){return t+96})),e},e}(s);e.MediaHeaderBoxParser=g;var w=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="hdlr",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return this.skipBytes(4),e.handlerType=this.readString(4),e.name=this.readString(),e},e}(s);e.HandlerBoxParser=w;var B=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="minf",e}(o);e.MediaInformationBoxParser=B;var b=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.type="vmhd",r.prototype.parse=function(){var r=e.prototype.parse.call(this);new t.DataView2(this.bytes),r.opcolor=[],r.graphicsmode=this.readUint16();for(var i=0;3>i;++i)r.opcolor.push(this.readUint16());return r},r}(s);e.VideoMediaHeaderBoxParser=b;var x=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="smhd",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.balance=this.readInt16(),e},e}(s);e.SoundMediaHeaderBoxParser=x;var U=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="hmhd",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.maxPDUsize=this.readUint16(),e.avgPDUsize=this.readUint16(),e.maxbitrate=this.readUint32(),e.avgbitrate=this.readUint32(),e},e}(s);e.HindMediaHeaderBoxParser=U;var _=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="nmhd",e}(s);e.NullMediaHeaderBoxParser=_;var k=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="dinf",e}(o);e.DataReferenceBoxParser=k;var O=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="url ",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.location=this.readUTF8StringNullTerminated(),e},e}(s);e.DataEntryUrlBoxParser=O;var S=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="urn ",e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.name=this.readUTF8StringNullTerminated(),e.location=this.readUTF8StringNullTerminated(),e},e}(s);e.DataEntryUrnBoxParser=S;var C=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="stbl",e}(o);e.SampleTableBoxParser=C;var T=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="stts",e.prototype.parse=function(){var e=t.prototype.parse.call(this),r=this.readUint32();e.entryCount=r,e.entries=[];for(var i=0;r>i;++i)e.entries.push({sampleCount:this.readUint32(),sampleDelta:this.readUint32()});return e},e}(s);e.TimeToSampleBoxParser=T;var D=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="ctts",e.prototype.parse=function(){var e=t.prototype.parse.call(this),r=this.readUint32();e.entryCount=r,e.entries=[];for(var i=0;r>i;++i)e.entries.push({sampleCount:this.readUint32(),sampleOffset:this.readUint32()});return e},e}(s);e.CompositionOffsetBoxParser=D;var I=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);return this.skipBytes(6),e.dataReferenceIndex=this.readUint16(),e},e}(n);e.SampleEntryParser=I;var P=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);return e.data=this.bytes.subarray(16),e},e}(I);e.HintSampleEntryParser=P;var F=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);return this.skipBytes(16),e.width=this.readUint16(),e.height=this.readUint16(),e.horizresolution=this.readUint32(),e.vertresolution=this.readUint32(),e.compressorname=this.readString(32),e.depth=this.readUint16(),e},e}(I);e.VisualSampleEntryParser=F;var A=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parse=function(){var e=t.prototype.parse.call(this);return this.skipBytes(8),e.channelcount=this.readUint16(),e.samplesize=this.readUint16(),this.skipBytes(4),e.samplerate=this.readUint32()>>>16,e},e}(I);e.AudioSampleEntryParser=A;var E=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.type="esds",r.prototype.parse=function(){var r=t.prototype.parse.call(this),i=e.getDescrInfo(this.bytes,12);return r.esDescr=new e.ESDescriptorParser(this.readBytes(i.byteLength)).parse(),r},r}(s);e.ESDBoxParser=E;var L=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mp4v",e.prototype.parse=function(){var e=t.prototype.parse.call(this),i=r(this.readBytes(8));return this.skipBytes(-8),e.esBox=new E(this.readBytes(i.byteLength)).parse(),e},e}(F);e.MP4VisualSampleEntryParser=L;var M=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mp4a",e.prototype.parse=function(){var e=t.prototype.parse.call(this),i=r(this.readBytes(8));return this.skipBytes(-8),e.esBox=new E(this.readBytes(i.byteLength)).parse(),e},e}(A);e.MP4AudioSampleEntryParser=M;var z=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mp4s",e.prototype.parse=function(){var e=t.prototype.parse.call(this),i=r(this.readBytes(8));return this.skipBytes(-8),e.esBox=new E(this.readBytes(i.byteLength)).parse(),e},e}(I);e.MpegSampleEntryParser=z;var V=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.type="stsd",i.prototype.parse=function(){var i=t.prototype.parse.call(this),n=this.readUint32();i.entryCount=n,i.boxes=[];for(var s=0;n>s;++s){var a=r(this.readBytes(8));this.skipBytes(-8),i.boxes.push(e.createBoxParser(this.readBytes(a.byteLength),a.type).parse())}return i},i}(s);e.SampleDescriptionBoxParser=V;var j=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="stsz",e.prototype.parse=function(){var e=t.prototype.parse.call(this),r=this.readUint32(),i=this.readUint32();if(0===r){e.sampleSizes=[];for(var n=0;i>n;++n)e.sampleSizes.push(this.readUint32())}return e.sampleSize=r,e.sampleCount=i,e},e}(s);e.SampleSizeBoxParser=j;var H=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.type="stsc",r.prototype.parse=function(){var r=e.prototype.parse.call(this),i=new t.DataView2(this.bytes),n=12,s=i.getUint32(n);r.entries=[];for(var a=0;s>a;++a)r.entries.push({firstChunk:i.getUint32(n+=4),samplesPerChunk:i.getUint32(n+=4),sampleDescriptionIndex:i.getUint32(n+=4)});return r},r}(s);e.SampleToChunkBoxParser=H;var R=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="stco",e.prototype.parse=function(){var e=t.prototype.parse.call(this),r=this.readUint32();e.entryCount=r,e.chunkOffsets=[];for(var i=0;r>i;++i)e.chunkOffsets.push(this.readUint32());return e},e}(s);e.ChunkOffsetBoxParser=R,e.createBoxParser=function(){var e={};return Object.keys(t.parser).forEach(function(r){var i=t.parser[r];i.type&&(e[i.type]=i)}),function(t,r){return new(e[r]||n)(t)}}()})(t.parser||(t.parser={})),t.parser})(mp4||(mp4={}));var mp4;(function(t){(function(e){var r=function(){function e(){this.bitOffset=0,this.bytes=new Uint8Array(2),this.view=new t.DataView2(this.bytes)}return e.prototype.compose=function(){var t=this.byteOffset;if(t>this.bytes.length){var e=new Uint8Array(t);return e.set(this.bytes),e}return this.bytes.subarray(0,t)},Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this.bitOffset>>>3},enumerable:!0,configurable:!0}),e.prototype.skipBits=function(t){this.bitOffset+=t},e.prototype.skipBytes=function(t){this.skipBits(8*t)},e.prototype.writeBits=function(t,e){this.expandBuffer(e);var r,i=Math.ceil((this.bitOffset%8+e)/8);switch(i){case 1:r=this.view.getUint8(this.byteOffset);break;case 2:r=this.view.getUint16(this.byteOffset);break;case 3:r=this.view.getUint24(this.byteOffset);break;case 4:r=this.view.getUint32(this.byteOffset)}switch(r|=t<<8*i-(this.bitOffset%8+e),i){case 1:this.view.setUint8(this.byteOffset,r);break;case 2:this.view.setUint16(this.byteOffset,r);break;case 3:this.view.setUint24(this.byteOffset,r);break;case 4:this.view.setUint32(this.byteOffset,r)}this.skipBits(e)},e.prototype.writeBytes=function(t){this.expandBuffer(8*t.length),this.bytes.set(t,this.byteOffset),this.skipBytes(t.length)},e.prototype.writeUint8=function(t){this.expandBuffer(8),this.view.setUint8(this.byteOffset,t),this.skipBytes(1)},e.prototype.writeInt8=function(t){this.expandBuffer(8),this.view.setInt8(this.byteOffset,t),this.skipBytes(1)},e.prototype.writeUint16=function(t){this.expandBuffer(16),this.view.setUint16(this.byteOffset,t),this.skipBytes(2)},e.prototype.writeInt16=function(t){this.expandBuffer(16),this.view.setInt16(this.byteOffset,t),this.skipBytes(2)},e.prototype.writeUint24=function(t){this.expandBuffer(24),this.view.setUint24(this.byteOffset,t),this.skipBytes(3)},e.prototype.writeInt24=function(t){this.expandBuffer(24),this.view.setInt24(this.byteOffset,t),this.skipBytes(3)},e.prototype.writeUint32=function(t){this.expandBuffer(32),this.view.setUint32(this.byteOffset,t),this.skipBytes(4)},e.prototype.writeInt32=function(t){this.expandBuffer(32),this.view.setInt32(this.byteOffset,t),this.skipBytes(4)},e.prototype.writeFloat32=function(t){this.expandBuffer(32),this.view.setFloat32(this.byteOffset,t),this.skipBytes(4)},e.prototype.writeFloat64=function(t){this.expandBuffer(64),this.view.setFloat64(this.byteOffset,t),this.skipBytes(8)},e.prototype.writeString=function(t){this.expandBuffer(8*t.length),this.view.setString(this.byteOffset,t),this.skipBytes(t.length)},e.prototype.writeStringNullTerminated=function(t){this.writeString(t+"\0")},e.prototype.writeUTF8String=function(e){var r=t.DataView2.stringToUTF8Bytes(e);this.expandBuffer(8*r.length),this.writeBytes(r)},e.prototype.writeUTF8StringNullTerminated=function(t){this.writeUTF8String(t+"\0")},e.prototype.expandBuffer=function(e){for(var r=8*this.bytes.length,i=r;i+e>r;)r*=2;var n=new Uint8Array(Math.ceil(r/8));n.set(this.bytes),this.bytes=n,this.view=new t.DataView2(n)},e}();e.BaseComposer=r})(t.composer||(t.composer={})),t.composer})(mp4||(mp4={}));var mp4;(function(){})(mp4||(mp4={}));var __extends=this.__extends||function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r},mp4;(function(t){(function(e){var r=function(t){function e(){t.call(this),this.skipBytes(4),this.writeString(this.constructor.type)}return __extends(e,t),e.prototype.compose=function(){return this.view.setUint32(0,this.byteOffset),t.prototype.compose.call(this)},e}(e.BaseComposer);e.BoxComposer=r;var i=function(t){function e(e){t.call(this),this.box=e,this.writeUint8(e.version||0),this.writeUint24(e.flags||0)}return __extends(e,t),e}(r);e.FullBoxComposer=i;var n=function(t){function e(e){var r=this;t.call(this),e.forEach(function(t){return r.writeBytes(t)})}return __extends(e,t),e}(r);e.BoxListComposer=n;var s=function(t){function e(e){var r=this;t.call(this),this.writeString(e.majorBrand),this.writeUint32(e.minorVersion),e.compatibleBrands.forEach(function(t){return r.writeString(t)})}return __extends(e,t),e.type="ftyp",e}(r);e.FileTypeBoxComposer=s;var a=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="moov",e}(n);e.MovieBoxComposer=a;var o=function(t){function e(e){t.call(this),this.writeBytes(e.data)}return __extends(e,t),e.type="mdat",e}(r);e.MediaDataBoxComposer=o;var p=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.creationTime),this.writeUint32(e.modificationTime),this.writeUint32(e.timescale),this.writeUint32(e.duration),this.writeInt32(e.rate),this.writeInt16(e.volume),this.skipBytes(2),this.skipBytes(8),e.matrix.forEach(function(t){return r.writeInt32(t)}),this.skipBytes(24),this.writeUint32(e.nextTrackID)}return __extends(e,t),e.type="mvhd",e}(i);e.MovieHeaderBoxComposer=p;var u=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="trak",e}(n);e.TrackBoxComposer=u;var h=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.creationTime),this.writeUint32(e.modificationTime),this.writeUint32(e.trackID),this.skipBytes(4),this.writeUint32(e.duration),this.skipBytes(8),this.writeInt16(e.layer),this.writeInt16(e.alternateGroup),this.writeInt16(e.volume),this.skipBytes(2),e.matrix.forEach(function(t){return r.writeInt32(t)}),this.writeUint32(e.width),this.writeUint32(e.height)}return __extends(e,t),e.type="tkhd",e}(i);e.TrackHeaderBoxComposer=h;var f=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="tref",e}(n);e.TrackReferenceBoxComposer=f;var c=function(t){function e(e){var r=this;t.call(this),e.trackIDs.forEach(function(t){return r.writeUint32(t)})}return __extends(e,t),e}(r);e.TrackReferenceTypeBoxComposer=c;var y=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="hint",e}(c);e.HintTrackReferenceTypeBoxComposer=y;var d=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="cdsc",e}(c);e.DescriptionTrackReferenceTypeBoxComposer=d;var l=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="mdia",e}(n);e.MediaBoxComposer=l;var m=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.creationTime),this.writeUint32(e.modificationTime),this.writeUint32(e.timescale),this.writeUint32(e.duration),this.skipBits(1),[].forEach.call(e.language,function(t,i){return r.writeBits(e.language.charCodeAt(i),5)}),this.skipBytes(2)}return __extends(e,t),e.type="mdhd",e}(i);e.MediaHeaderBoxComposer=m;var v=function(t){function e(e){t.call(this,e),this.skipBytes(4),this.writeString(e.handlerType),this.skipBytes(8),this.writeUTF8StringNullTerminated(e.name)}return __extends(e,t),e.type="hdlr",e}(i);e.HandlerBoxComposer=v;var g=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="minf",e}(n);e.MediaInformationBoxComposer=g;var w=function(t){function e(e){var r=this;t.call(this,e),this.writeUint16(e.graphicsmode),e.opcolor.forEach(function(t){return r.writeUint16(t)})}return __extends(e,t),e.type="vmhd",e}(i);e.VideoMediaHeaderBoxComposer=w;var B=function(t){function e(e){t.call(this,e),this.writeInt16(e.balance),this.skipBytes(2)}return __extends(e,t),e.type="smhd",e}(i);e.SoundMediaHeaderBoxComposer=B;var b=function(t){function e(e){t.call(this,e),this.writeUint16(e.maxPDUsize),this.writeUint16(e.avgPDUsize),this.writeUint32(e.maxbitrate),this.writeUint32(e.avgbitrate),this.skipBytes(4)}return __extends(e,t),e.type="hmhd",e}(i);e.HindMediaHeaderBoxComposer=b;var x=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="nmhd",e}(i);e.NullMediaHeaderBoxComposer=x;var U=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="dinf",e}(n);e.DataInformationBoxComposer=U;var _=function(t){function e(e){t.call(this,e),this.writeUTF8StringNullTerminated(e.location)}return __extends(e,t),e.type="url ",e}(i);e.DataEntryUrlBoxComposer=_;var k=function(t){function e(e){t.call(this,e),this.writeUTF8StringNullTerminated(e.name),this.writeUTF8StringNullTerminated(e.location)}return __extends(e,t),e.type="urn ",e}(i);e.DataEntryUrnBoxComposer=k;var O=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.entries.forEach(function(t){var e=j(t);r.writeBytes(e.compose())})}return __extends(e,t),e.type="dref",e}(i);e.DataReferenceBoxComposer=O;
var S=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.type="stbl",e}(n);e.SampleTableBoxComposer=S;var C=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.entries.forEach(function(t){r.writeUint32(t.sampleCount),r.writeUint32(t.sampleDelta)})}return __extends(e,t),e.type="stts",e}(i);e.TimeToSampleBoxComposer=C;var T=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.entries.forEach(function(t){r.writeUint32(t.sampleCount),r.writeUint32(t.sampleOffset)})}return __extends(e,t),e.type="ctts",e}(i);e.CompositionOffsetBoxComposer=T;var D=function(t){function e(e){t.call(this),this.skipBytes(6),this.writeUint16(e.dataReferenceIndex)}return __extends(e,t),e}(r);e.SampleEntryComposer=D;var I=function(t){function e(e){t.call(this,e),this.writeBytes(e.data)}return __extends(e,t),e}(D);e.HintSampleEntryComposer=I;var P=function(t){function e(e){t.call(this,e),this.skipBytes(2),this.skipBytes(2),this.skipBytes(12),this.writeUint16(e.width),this.writeUint16(e.height),this.writeUint32(e.horizresolution),this.writeUint32(e.vertresolution),this.skipBytes(4),this.writeUint16(e.frameCount),this.writeString(e.compressorname),this.writeUint16(e.depth),this.writeUint16(-1)}return __extends(e,t),e}(D);e.VisualSampleEntryComposer=P;var F=function(t){function e(e){t.call(this,e),this.writeBytes(j(e.esBox).compose())}return __extends(e,t),e.type="mp4v",e}(P);e.MP4VisualSampleEntryComposer=F;var A=function(t){function e(e){t.call(this,e),this.skipBytes(8),this.writeUint16(e.channelcount),this.writeUint16(e.samplesize),this.skipBytes(2),this.skipBytes(2),this.writeUint32(e.samplerate<<16>>>0)}return __extends(e,t),e}(D);e.AudioSampleEntryComposer=A;var E=function(t){function e(e){t.call(this,e),this.writeBytes(j(e.esBox).compose())}return __extends(e,t),e.type="mp4a",e}(A);e.MP4AudioSampleEntryComposer=E;var L=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.boxes.forEach(function(t){var e=j(t);r.writeBytes(e.compose())})}return __extends(e,t),e.type="stsd",e}(i);e.SampleDescriptionBoxComposer=L;var M=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.sampleSize),0===e.sampleSize&&e.sampleSizes.forEach(function(t){return r.writeUint32(t)})}return __extends(e,t),e.type="stsz",e}(i);e.SampleSizeBoxComposer=M;var z=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.entries.forEach(function(t){r.writeUint32(t.firstChunk),r.writeUint32(t.samplesPerChunk),r.writeUint32(t.sampleDescriptionIndex)})}return __extends(e,t),e.type="stsc",e}(i);e.SampleToChunkBoxComposer=z;var V=function(t){function e(e){var r=this;t.call(this,e),this.writeUint32(e.entryCount),e.chunkOffsets.forEach(function(t){return r.writeUint32(t)})}return __extends(e,t),e.type="stco",e}(i);e.ChunkOffsetBoxComposer=V;var j=function(){var e={};return Object.keys(t.composer).forEach(function(r){var i=t.composer[r];i.type&&(e[i.type]=i)}),function(t){return new e[t.type](t)}}()})(t.composer||(t.composer={})),t.composer})(mp4||(mp4={}));var mp4;(function(t){var e=function(){function t(t){this.tree=t}return t.prototype.findOne=function(t){var e,r=function(i){if(!e){switch(typeof i){case"number":case"string":case"boolean":return}return i.type===t?e=i:(i.buffer||Object.keys(i).forEach(function(t){var e=i[t];Array.isArray(e)?e.some(r):e.type&&r(e)}),void 0)}};return r(this.tree),e},t.prototype.findAll=function(t){var e=[],r=function(i){switch(typeof i){case"number":case"string":case"boolean":return}i.type===t&&e.push(i),i.buffer||Object.keys(i).forEach(function(t){var e=i[t];Array.isArray(e)?e.forEach(r):r(e)})};return r(this.tree),e},t}();t.Finder=e})(mp4||(mp4={}));var mp4;(function(t){var e=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3];t.parse=function(e){return new t.parser.RootParser(e).parse()};var r=function(e,r){var i,n,s,a,o,p,u,h,f,c=[],y=new t.Finder(r),d=y.findOne("stsc"),l=y.findOne("stsz"),m=y.findOne("stco");for(i=0,a=0,o=d.entryCount;o>i;++i)for(n=d.entries[i].firstChunk-1,p=o>i+1?d.entries[i+1].firstChunk-1:m.chunkOffsets.length;p>n;++n){for(h=f=m.chunkOffsets[n],s=0,u=d.entries[i].samplesPerChunk;u>s;++s,++a)f+=l.sampleSizes[a];c.push(e.subarray(h,f))}return c},i=function(e){var r,i=new t.Finder(e);return i.findAll("trak").some(function(e){var i=new t.Finder(e).findOne("hdlr");return"soun"===i.handlerType?r=e:void 0}),r},n=function(t){var e,r,i=0,n=0;for(e=0,r=t.length;r>e;++e)i+=t[e].length;var s=new Uint8Array(i);for(e=0;r>e;++e)s.set(t[e],n),n+=t[e].length;return s};t.extractAudioAsM4A=function(e){var s=t.parse(e),a=new t.Finder(s),o=48,p=new t.composer.FileTypeBoxComposer({majorBrand:"mp4a",minorVersion:0,compatibleBrands:["mp42","isom","ndia"]}).compose();o+=p.length;var u=a.findOne("mvhd").bytes;o+=u.length;var h=i(s);a=new t.Finder(h);var f=a.findOne("tkhd").bytes;o+=f.length,a=new t.Finder(a.findOne("mdia"));var c=a.findOne("mdhd").bytes,y=a.findOne("hdlr").bytes;o+=c.length+y.length,a=new t.Finder(a.findOne("minf"));var d=a.findOne("smhd").bytes,l=a.findOne("dinf").bytes;o+=d.length+l.length,a=new t.Finder(a.findOne("stbl"));var m=a.findOne("stsd").bytes,v=a.findOne("stts").bytes,g=a.findOne("stsc").bytes,w=a.findOne("stsz").bytes,B=a.findOne("stco"),b=B.bytes;o+=m.length+v.length+g.length+w.length+b.length;for(var x=r(e,h),U=[o],_=1,k=x.length;k>_;++_)o+=x[_].length,U[_]=o;b=new t.composer.ChunkOffsetBoxComposer({entryCount:B.entryCount,chunkOffsets:U}).compose();var O=new t.composer.MediaDataBoxComposer({data:n(x)}).compose(),S=new t.composer.SampleTableBoxComposer([m,v,w,b]).compose(),C=new t.composer.MediaInformationBoxComposer([d,l,S]).compose(),T=new t.composer.MediaBoxComposer([c,y,C]).compose(),D=new t.composer.TrackBoxComposer([f,T]).compose(),I=new t.composer.MovieBoxComposer([u,D]).compose();return n([p,I,O])},t.extractAudioAsAAC=function(r){var n=new t.Finder(i(t.parse(r))),s=n.findOne("mp4a"),a=n.findOne("stsc"),o=n.findOne("stsz"),p=n.findOne("stco"),u=new Uint8Array(7*o.sampleSizes.length+o.sampleSizes.reduce(function(t,e){return t+e})),h=0,f=new Uint8Array(7);f[0]=255,f[1]=249,f[2]=64|e.indexOf(s.samplerate<<2)|s.channelcount>>2,f[6]=252;var c,y,d,l,m,v,g,w,B;for(c=0,l=0,m=a.entryCount;m>c;++c)for(y=a.entries[c].firstChunk-1,v=m>c+1?a.entries[c+1].firstChunk-1:p.chunkOffsets.length;v>y;++y)for(w=p.chunkOffsets[y],d=0,g=a.entries[c].samplesPerChunk;g>d;++d,++l)B=o.sampleSizes[l]+7,f[3]=s.channelcount<<6|B>>11,f[4]=B>>3,f[5]=31|B<<5,u.set(f,h),h+=7,u.set(r.subarray(w,w+=o.sampleSizes[l]),h),h+=o.sampleSizes[l];return u}})(mp4||(mp4={}));